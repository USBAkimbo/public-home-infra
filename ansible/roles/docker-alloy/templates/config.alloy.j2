// ============================================
// FILE LOGS - System and TrueNAS specific
// ============================================
local.file_match "local_files" {
  path_targets = [
    // General system logs
    {
      __path__   = "/var/log/*.log",
      job        = "varlogs",
      hostname   = constants.hostname,
    },
    {
      __path__   = "/var/log/*/*.log",
      job        = "varlogs_recursive",
      hostname   = constants.hostname,
    },
    // TrueNAS specific logs
    {
      __path__   = "/var/log/middlewared.log",
      job        = "truenas_middleware",
      hostname   = constants.hostname,
    },
    {
      __path__   = "/var/log/syslog",
      job        = "truenas_syslog",
      hostname   = constants.hostname,
    },
    {
      __path__   = "/var/log/daemon.log",
      job        = "truenas_daemon",
      hostname   = constants.hostname,
    },
    {
      __path__   = "/var/log/debug",
      job        = "truenas_debug",
      hostname   = constants.hostname,
    },
  ]
  sync_period = "5s"
}

loki.source.file "log_scrape" {
  targets       = local.file_match.local_files.targets
  forward_to    = [loki.write.loki_server.receiver]
  tail_from_end = true
}

// ============================================
// SYSTEMD JOURNAL LOGS
// ============================================
loki.source.journal "journal_reader" {
  forward_to = [loki.relabel.journal_labels.receiver]
  labels = {
    job      = "systemd-journal",
    hostname = constants.hostname,
  }
}

loki.relabel "journal_labels" {
  forward_to = [loki.write.loki_server.receiver]

  rule {
    source_labels = ["__journal__systemd_unit"]
    target_label  = "unit"
  }
  rule {
    source_labels = ["__journal_priority_keyword"]
    target_label  = "level"
  }
  rule {
    source_labels = ["__journal_syslog_identifier"]
    target_label  = "syslog_identifier"
  }
}

// ============================================
// DOCKER CONTAINER LOGS
// ============================================
discovery.docker "containers" {
  host = "unix:///var/run/docker.sock"
}

discovery.relabel "docker_logs" {
  targets = []

  rule {
    source_labels = ["__meta_docker_container_name"]
    regex         = "/(.*)"
    target_label  = "service_name"
  }
}

loki.source.docker "docker_containers" {
  host          = "unix:///var/run/docker.sock"
  targets       = discovery.docker.containers.targets
  labels        = {
    job      = "docker",
    platform = "docker",
    hostname = constants.hostname,
  }
  relabel_rules = discovery.relabel.docker_logs.rules
  forward_to    = [loki.write.loki_server.receiver]
}

// ============================================
// SYSLOG RECEIVER - UDP only
// ============================================
loki.relabel "syslog_labels" {
  forward_to = [loki.write.loki_server.receiver]

  // Replace service label
  rule {
    target_label  = "service"
    replacement   = "syslog"
  }
  
  // Use message_hostname as hostname
  rule {
    source_labels = ["message_hostname"]
    target_label  = "hostname"
  }

  // Retain all other syslog metadata as labels
  rule {
    action = "labelmap"
    regex  = "__syslog_(.+)"
  }
}

loki.source.syslog "syslog_receiver" {
  // UDP listener on port 514
  listener {
    address                 = "0.0.0.0:514"
    protocol                = "udp"
    labels                  = { 
      job       = "syslog",
      protocol  = "udp",
      hostname  = constants.hostname,
    }
    use_incoming_timestamp  = true
    label_structured_data   = true
  }

  forward_to    = [loki.relabel.syslog_labels.receiver]
  relabel_rules = loki.relabel.syslog_labels.rules
}

// ============================================
// LOKI DESTINATION
// ============================================
loki.write "loki_server" {
  endpoint {
    url = "http://{{ LOKI_IP }}:3100/loki/api/v1/push"
  }
}
